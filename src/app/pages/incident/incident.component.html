<div class="surface-ground p-2">
    <p-toast/>
    <p-confirmPopup/>
    <!--Ce composant affiche le loader-->
    <app-loading [(isLoading)]="isLoading"/>
    <div class="flex align-items-center justify-content-between">
        <h4 style="color: rgb(74, 183, 237);" class="m-0">Liste des incidents</h4>
        <span class="p-input-icon-left">
            <i class="pi pi-search pi pi-spinner pi-spin" ></i>
            <input 
                pInputText 
                type="text"  
                placeholder="Search..."
                (input)="onFilter($event)"/>
        </span>
    </div>
    <!--
        Composant table voir primeNG: https://primeng.org/table 
    -->
    <p-table #dt 
        [value]="incidents()"
        styleClass="p-datatable-striped" 
        [paginator]="true"
        [rows]="5"
        [rowsPerPageOptions]="[5, 10, 20]"
        [globalFilterFields]="['nom', 'description','priorite','statut','type_incident_id','Service']">
        <ng-template pTemplate="header">
            <tr>
                <th>Nom</th>
                <th>Type</th>
                <th>Service</th>
                <th>Status</th>
                <th>Priorite</th>
                <th>Description</th>
                <th></th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-incident>
            <tr>
                <td>{{incident.nom}}</td>
                <td>{{incident.type_incident.nom}}</td>
                <td>{{incident.service.nom}}</td>
                <td>{{incident.statut}}</td>
                <td>{{incident.priorite}}</td>
                <td>{{incident.description}}</td>
                <td class="flex flex-wrap gap-2">
                    <!--Bouttons d'action voir incident.component.ts pour les fonctions -->
                    <p-button (click)="update(incident) ;showCommentDialog()" icon="pi pi-twitch" [outlined]="true"  [rounded]="true" severity="success" title="Gerer l'incident"/>
                    <p-button (click)="showPrioriteDialog(incident)" icon="pi pi-star" [outlined]="true"  [rounded]="true" severity="warning" title="Prioriter l'incident"/>
                    <p-button (click)="showStatutDialog(incident)" icon="pi pi-check" [outlined]="true"  [rounded]="true" severity="info" title="Traiter l'incident"/>
                    <p-button (click)="update(incident)" icon="pi pi-pencil" [outlined]="true"  [rounded]="true" severity="info" />
                    <p-button icon="pi pi-eye" [outlined]="true" [rounded]="true" severity="info" (onClick)="showInciDetails(incident)" title="Voir details"/>
                    <p-button icon="pi pi-user" [outlined]="true" [rounded]="true" severity="info" (onClick)="selectUser(incident)" title="Affecter la gestion a un agent"/>
                    <p-button (click)="confirmDelete($event, incident) "  icon="pi pi-trash" [outlined]="true"  [rounded]="true" severity="danger" title="Supprimer" />
                </td>
            </tr>
        </ng-template>
    </p-table>
    <app-user-selector role="Agent" [(visible)]="showSelectUserDialog" [isSingle]="true" (onSingleUserSelected)="onUserSelected($event)" />

    <p-dialog header="Détails"  [(visible)]="showInciDetailsDialog" [modal]="true" [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" 
        [style]="{ width: '50vw' }" [draggable]="false" [resizable]="false">
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; padding: 20px;">
                <div style="width: 45%; padding-right: 10px;">
                               <p>
                                   <strong>Nom :</strong> {{selectedIncident()?.nom}}
                               </p>
                               <p>
                                   <strong>Soumis par :</strong> {{selectedIncident()?.soumis_par?.prenom}} {{selectedIncident()?.soumis_par?.nom}} 
                               </p>
                               <p>
                                   <strong>Date de soumission :</strong> {{selectedIncident()?.date_soumission}}
                               </p>
                           </div>
                           <div style="width: 45%; padding-left: 10px;">
                               <p>
                                   <strong>Prise en charge par :</strong> {{ selectedIncident()?.prise_en_charge_par?.prenom}} {{selectedIncident()?.prise_en_charge_par?.nom}}
                               </p>
                               <p>
                                   <strong>Date prise en charge :</strong> {{selectedIncident()?.date_prise_en_charge}}
                               </p>
                               <p>
                                   <strong>Commentaires :</strong> {{selectedIncident()?.commentaires}}
                               </p> 
                           </div>
                       </div>
                   
                   </p-dialog>

                   <p-dialog header="Commentaires" [(visible)]="visible" [modal]="true" [style]="{ width: '25rem' }">
                    <span class="p-text-secondary block mb-5">
                        Laisser un commentaire de la prise en charge de l'incident
                    </span>
                
                    <form [formGroup]="incidentForm" (ngSubmit)="saveComment()">
                        <div class="flex align-items-center gap-3 mb-5">
                            <label for="commentaire" class="font-semibold w-6rem">Commentaire</label>
                            <textarea
                                id="commentaire"
                                formControlName="commentaire"                 
                                class="p-inputtext p-component w-full"
                                placeholder="Écrire un commentaire">
                            </textarea>
                        </div>
                
                        <div class="flex justify-content-end gap-2">
                            <p-button label="Annuler" severity="secondary" (click)="visible = false"></p-button>
                            <p-button label="Enregistrer" severity="info" type="submit"></p-button>
                        </div>
                    </form>
                </p-dialog>
          <!--.......................................... p-dialog pour la gestion des priorités............................................. -->
           <p-dialog header="Priorite" [(visible)]="visiblePriorite" [modal]="true" [style]="{ width: '25rem' }">
            <span class="p-text-secondary block mb-5">
                Sélectionner la priorité de l'incident :
            </span>
            <form [formGroup]="incidentForm" (ngSubmit)="savePriorite()">
                <div class="flex align-items-center gap-3 mb-5">
                    <div class="flex align-items-center" *ngFor ="let priorite of prioriteIncident | keyvalue">
                        <p-radioButton name="priorite" [value]="priorite.value.value" formControlName="priorite" [inputId]="'priorite'+priorite.key"></p-radioButton>
                        <label [for]="'priorite'+priorite.key" class="ml-2">{{priorite.value.value}}</label>
                    </div>
                </div>  
                <div class="flex justify-content-end gap-2">
                    <p-button label="Annuler" severity="secondary" (click)="visiblePriorite = false"></p-button>
                    <p-button label="Enregistrer" severity="info" type="submit"></p-button>
                </div>
            </form>
        </p-dialog>    

        <!-- .......................................... p-dialog pour la gestion des statuts............................................. -->
         <p-dialog header="Statut" [(visible)]="visibleStatut" [modal]="true" [style]="{ width: '25rem' }">
            <span class="p-text-secondary block mb-5">
                Sélectionner le statut de l'incident :
            </span>
            <form [formGroup]="incidentForm" (ngSubmit)="saveStatut()">
                <div class="flex align-items-center gap-3 mb-5">
                    <div class="flex align-items-center" *ngFor ="let statut of statutIncident | keyvalue">
                        <p-radioButton name="statut" [value]="statut.value.value" formControlName="statut" [inputId]="'statut'+statut.key"></p-radioButton>
                        <label [for]="'statut'+statut.key" class="ml-2">{{statut.value.value}}</label>
                    </div>
                </div> 
                <div class="flex justify-content-end gap-2">
                    <p-button label="Annuler" severity="secondary" (click)="visibleStatut = false"></p-button>
                    <p-button label="Enregistrer" severity="info" type="submit"></p-button>
                </div>
            </form>
        </p-dialog>